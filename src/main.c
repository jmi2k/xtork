#include "u.h"
#include "command.h"

const char BANNER[] =
	"\r\n"
	"\x1BPq"
	"???????????_s{{{{}}}}}}{][wo??????????MP``aa[???$-"
	"???????ow}~~~~~~~~~~~~~{ww{~nR[~~}}}{{w]P???????$-"
	"????o{~~~~~~~~~~~~~~~~~~~~~^B@??????_[b_????????$-"
	"_w{{xzvnnn^^^~~~~~~~~~~~~~^[????????FCC?????????$-"
	"~~~~~~~~~~~~~}}|||zz|||}}}~~~~~}{wo?????????????$-"
	"^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~{_??????????$-"
	"?b^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~w?????????$-"
	"?~?xBVnN^^~~~~~~~~~~~~~~~~~~~~~~~~~~~~Nw_???????$-"
	"?B?^?}@rN~}}||zzvvnn^^^~~~~~~~~~~~~^fw~~~w??????$-"
	"?????N?~?{Bf^~~~~~~~~~~}}||zzzvvnvx}~~~^^nS?????$-"
	"???????B?N?F???D\\zzzrJzrjZzzrjZzzzz||}?~?~?~????$-"
	"???????????????_w{BFN~}|rn]|zvn]|zvn^b{~oN~?~???$-"
	"??????????@@@BB@?@@@BA@FN^~}|zf^}|zvn^~~No~wF~??$-"
	"???????????????????????????BFN^~}|zvn^]}~~~~?~~?$-"
	"????????????????????????????????@FN^~~}}||zz{~~o$-"
	"?????????????????????????????????????@BBFN^^^~~N$-"
	"\x1B\\"
	"\r\n"
	"\r\n";

int
read_line(Uart *const uart, char *const line, int len, char *const prompt)
{
	put_string(uart, prompt);
	int pos = 0;

	for (;;) {
		char chr = get_char(uart);

		// Finish reading line
		if (chr == '\r') {
			put_string(uart, "\r\n");
			break;
		}

		// Handle backspace
		if (chr == '\x7F') {
			if (pos > 0) {
				pos--;
				put_string(uart, "\b \b");
			}

			continue;
		}

		// Avoid overflow
		if (pos >= len-1)
			continue;

		put_char(uart, chr);
		line[pos++] = chr;
	}

	line[pos] = '\0';
	return pos;
}

int
main(void)
{
	static char new_line[256U];
	static char line[256U];

	put_string(ICELINK, BANNER);
	lookup_command("video/hello")();

	for (;;) {
		if (read_line(ICELINK, new_line, NELEMS(line), "âŒ‚  "))
			copy_memory(new_line, line, NELEMS(line));

		Command *command = lookup_command(line);

		if (!command) {
			put_string(ICELINK, "Unknown command\r\n");
			continue;
		}

		unsigned long t = read_time();
		command();

		unsigned dt = read_time() - t;
		print(ICELINK, "%d ms (%d cycles)\r\n", dt / 77500U, dt);
	}

	return 0;
}
